define(["logBee","jquery","ko","js/codemirror","beautifier","js/organizations/alerts/SelectRequestModal","js/organizations/alerts/NotificationComponent","js/formatFileContent"],function(a,l,n,o,t,i,s,c){let r=null,d=null,p=null,u=null,f=null,m=null;function h(e){var t=d.getValue().trim(),t=g(t);d.setValue(t),e&&d.focus()}function b(){var e,t=k.selectedRequest();t&&(e=d.getValue())&&e.trim()&&l.post("/Components/EvaluateAlert",{requestId:t.id,applicationId:t.applicationId,javascriptCode:e}).done(e=>{k.evaluateResult(e)}).fail(function(e){a.showXhrErrorToast(e,!0)})}function g(e){try{return t.js_beautify(e,{max_preserve_newlines:2})}catch(e){}return e}function v(){l("#content").find("[data-container]").removeClass("d-none"),d.refresh(),l("#Name").focus()}function T(){var e=l("#alert-form"),t=e.find("input[name='AppliesToAllApplications']:checked").val();(e=e.find("[data-appliesTo-container]")).children().hide(),e.find(`[data-value='${t}']`).show(),/true$/i.test(t),/false$/i.test(t)}const k={selectedRequest:n.observable(null),selectedApplicationId:n.observable(""),appliesToAllApplications:n.observable("true"),appliesToApplications:n.observableArray([]),contextHtml:n.observable(null),evaluateResult:n.observable(null)};return{init:function(){a.bindForm("alert-form"),l("#alert-form").data("validator").settings.submitHandler=function(e,t){a.toggleFormLoading(l("#content"),!0),h(!1),d.save();{var o=l("#alert-form"),i=(o.children("[data-notifications-hidden-fields]").remove(),o.prepend("<div data-notifications-hidden-fields=''></div>"),o.children("[data-notifications-hidden-fields]"));i.length&&i.empty();let n=u.getData(),a=l("<input type='hidden' name='EmailNotification.IsEnabled' />").val(n.isEnabled);i.append(a[0].outerHTML);for(let e=0,t=n.values.length;e<t;e++)a=l(`<input type='hidden' name='EmailNotification.SendTo[${e}]' />`).val(n.values[e]),i.append(a[0].outerHTML);n=f.getData(),a=l("<input type='hidden' name='SlackNotification.IsEnabled' />").val(n.isEnabled),i.append(a[0].outerHTML);for(let e=0,t=n.values.length;e<t;e++)a=l(`<input type='hidden' name='SlackNotification.WebhookUrls[${e}]' />`).val(n.values[e]),i.append(a[0].outerHTML);n=m.getData(),a=l("<input type='hidden' name='MicrosoftTeamsNotification.IsEnabled' />").val(n.isEnabled),i.append(a[0].outerHTML);for(let e=0,t=n.values.length;e<t;e++)a=l(`<input type='hidden' name='MicrosoftTeamsNotification.WebhookUrls[${e}]' />`).val(n.values[e]),i.append(a[0].outerHTML)}return!0},e=l("#content").find("#JavascriptCode")[0],t=a.getTheme(),e=o.fromTextArea(e,{lineNumbers:!0,styleActiveLine:!0,matchBrackets:!0,mode:"javascript",theme:/^dark/i.test(t)?"base16-dark":"base16-light",viewportMargin:1/0}),l("#content").find("#JavascriptCode").parent().children(".CodeMirror").addClass("h-auto"),e.on("change",function(e){clearTimeout(r),r=setTimeout(function(){b()},500)}),d=e,(p=new i({requestsTableUrlParams:function(){return{applicationId:k.selectedApplicationId()}},onSelectedRequestChanged:function(e){e=e,k.selectedRequest(e),e&&l.get("/Components/DownloadAlertContext",{requestId:e.id,applicationId:e.applicationId}).done(e=>{delete e.RequestLog.WebRequest;e=`const context = ${JSON.stringify(e,null,4)};`;c.highlightContent(e).then(e=>{e&&k.contextHtml(e)})}).fail(function(e){a.showXhrErrorToast(e,!0)})}})).requestsTable.searchTable.events.once("afterDataSet",function(e){v()}),k.selectedApplicationId.subscribe(function(e){k.selectedRequest(null),e&&p.reload()}),k.selectedRequest.subscribe(function(e){b()}),u=new s({$container:l("#email-notification"),title:"Email",description:"Send an email when this alert is triggered",placeholder:"Email address",validateValue:function(e){return new RegExp("^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:.[a-zA-Z0-9-]+)*$").test(e)}}),f=new s({$container:l("#slack-notification"),title:"Slack",description:"Send a Slack notification when this alert is triggered",placeholder:"Webhook url",validateValue:function(e){return/^(http:\/\/|https:\/\/)/.test(e)},formTextHtml:'<a href="https://api.slack.com/messaging/webhooks" target="_blank">https://api.slack.com/messaging/webhooks</a>'}),m=new s({$container:l("#microsoft-teams-notification"),title:"Microsoft Teams",description:"Send a Microsoft Teams notification when this alert is triggered",placeholder:"Webhook url",validateValue:function(e){return/^(http:\/\/|https:\/\/)/.test(e)},formTextHtml:'<a href="https://learn.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/add-incoming-webhook?tabs=dotnet" target="_blank">https://learn.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/add-incoming-webhook?tabs=dotnet</a>'}),(t=a.htmlDecode(l("#page-model").html()))&&(t=JSON.parse(t),k.appliesToAllApplications(t.appliesToAllApplications.toString()),k.appliesToApplications(t.appliesToSpecificApplications||[]),u.setData(t.emailNotification.isEnabled,t.emailNotification.sendTo),f.setData(t.slackNotification.isEnabled,t.slackNotification.webhookUrls),m.setData(t.microsoftTeamsNotification.isEnabled,t.microsoftTeamsNotification.webhookUrls));var e=l("#content").find("[data-form-container]"),t=l("#content").find("[data-instructions-container]"),e=(n.applyBindings(k,e[0]),n.applyBindings(k,t[0]),l("#content").find("[data-format-code]").each(function(){const t=l(this);var e=a.htmlDecode(t.html());const n=g(e);c.highlightContent(n).then(e=>{e?t.html(e):t.html(n)})}),l("#content").on("click","[data-format-button]",function(e){e.preventDefault(),h(!0)}),l("#content").on("click","[data-view-examples-button]",function(e){e.preventDefault(),require(["js/components/alertExamplesModal"],function(e){e.open({onCodeSelected:function(e,t){d.setValue(e),t.close(),d.focus()}})})}),l("#content").on("click","[data-change-context-button]",function(e){e.preventDefault(),p.open()}),l("#content").on("click","button[data-submit]",function(){l("#alert-form").submit()}),l("#content").on("change","[name=AppliesToAllApplications]",function(){T()}),T(),l("#content").find("select[data-applications]"));e.length&&e.children("option").length||v()}}});
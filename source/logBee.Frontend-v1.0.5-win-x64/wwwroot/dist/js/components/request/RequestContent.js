define(["jquery","logBee","ko","chart-js","luxon","js/chart-utils","js/formatFileContent"],function(i,r,a,s,l,d,n){const u={domId:""};function t(t){this._options=i.extend(!0,{},u,t);const e=this;this.POPOVERS=[];var t=i("#"+this._options.domId),o=r.htmlDecode(t.find("[data-model]").html());const n=JSON.parse(o);this._viewModel={requestLog:n.requestLog},this._viewModel.keyValueArrayFormattedValue=function(t){const o={};return t.forEach((t,e)=>o[t.key]=t.value),JSON.stringify(o,null,2)},this._viewModel.callerInfoTitle=function(t){var e=[];return e.push(""+t.memberType),e.push(t.memberName+":"+t.lineNumber),e.join("\n")},this._viewModel.logMessageDurrationText=function(t,e){let o=t.millisecondsSinceLoggerWasCreated;return 0<e&&(t=n.requestLog.logs[e-1].millisecondsSinceLoggerWasCreated,o-=t),"+"+r.formatMilliseconds(o)},this._viewModel.logMessageDurrationTitle=function(t,e){var o=[];return 0<e&&(e=n.requestLog.logs[e-1].millisecondsSinceLoggerWasCreated,e=t.millisecondsSinceLoggerWasCreated-e,o.push(`+${r.formatMilliseconds(e)} from the previous log`)),o.push(r.formatMilliseconds(t.millisecondsSinceLoggerWasCreated)+" since the start of the request"),o.join("\n")},a.applyBindings(this._viewModel,t[0]),this._endpointChart=function(t,e){for(var t=t.find("[data-endpoint-http-traffic-chart]"),o=[],n=0,i=e.intervals.length;n<i;n++)o.push(e.intervals[n].from);t=t[0].getContext("2d");return new s(t,{type:"line",options:{onResize:function(t,e){e=e.width;const n=600<=e?2:480<=e?3:4;t.options.scales.x.ticks.callback=function(t,e,o){return(t+1)%n!=0?null:(t=this.getLabelForValue(t),l.DateTime.fromISO(t).toFormat("dd-MM"))}},responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{intersect:!1,mode:"index",callbacks:{title:function(t,e){t=t[0].label;return l.DateTime.fromISO(t).toFormat("dd MMMM")}}},verticalLiner:{lineWidth:3,color:"#282c34"}},scales:{y:{beginAtZero:!0,position:"right"},x:{ticks:{}}},elements:{point:{radius:0},line:{borderWidth:2}}},plugins:[d.verticalLinerPlugin],data:{labels:o,datasets:[{label:"Server errors",fill:!0,backgroundColor:d.statusCode500BackgroundGradient(t,100),borderColor:d.statusCode500BorderColor(),data:e.intervals.map(function(o){let n=0;for(let t=0,e=o.value.length;t<e;t++)500<=o.value[t].httpStatusCode&&(n+=o.value[t].count);return n})},{label:"Client errors",fill:!0,backgroundColor:d.statusCode400BackgroundGradient(t,100),borderColor:d.statusCode400BorderColor(),data:e.intervals.map(function(o){let n=0;for(let t=0,e=o.value.length;t<e;t++)400<=o.value[t].httpStatusCode&&o.value[t].httpStatusCode<500&&(n+=o.value[t].count);return n})},{label:"Success",fill:!0,backgroundColor:d.statusCode200BackgroundGradient(t,100),borderColor:d.statusCode200BorderColor(),data:e.intervals.map(function(o){let n=0;for(let t=0,e=o.value.length;t<e;t++)o.value[t].httpStatusCode<400&&(n+=o.value[t].count);return n})}]}})}(t,n.endpointChartData),t.find("[data-time-ago]").each(function(){r.timeAgoTag(i(this))}),t.find("[data-numeral]").each(function(){r.formatNumeralTag(i(this))}),t.find(".container-fluid").each(function(){i(this).children(".row").each(function(t,e){t%2==0&&i(this).addClass("bg-200")})}),t.on("click","[data-bs-toggle]",function(t){return t.preventDefault(),!1}),t.find("[data-popover-id]").each(function(){var t=r.bindPopover(i(this));e.POPOVERS.push(t)}),this._formatInputStream()}return t.prototype.destroy=function(){var t=i("#"+this._options.domId);this._endpointChart&&this._endpointChart.destroy();for(let t=0,e=this.POPOVERS.length;t<e;t++)this.POPOVERS[t]&&this.POPOVERS[t].dispose();a.disposeKoViewModel(this._viewModel,t)},t.prototype._formatInputStream=function(){const e=i("#"+this._options.domId).find("[data-input-stream]");if(e.length){var o=!!this._viewModel.requestLog.httpProperties.request&&this._viewModel.requestLog.httpProperties.request.headers,o=!!o&&o.find(t=>/^Content\-Type$/i.test(t.key));let t="unknown";o&&/\/json/i.test(o.value)&&(t="inputStream.json"),console.log("fileName",t),n.formatAndHighlightContent(r.htmlDecode(e.text()),t).then(t=>{t&&e.html(t)})}},t});
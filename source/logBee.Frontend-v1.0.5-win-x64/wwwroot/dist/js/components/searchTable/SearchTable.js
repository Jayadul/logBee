define(["logBee","jquery","Emitter","ko","numeral","bootstrap","js/components/searchTable/ColumnFilter","js/components/searchTable/SortOperator","js/components/searchTable/FilterConstructor","jquery.simplePagination"],function(s,d,i,h,n,o,a,e,r){function l(t){t.find(".page-link").removeClass("page-link").addClass("page"),t.find("span.current").each(function(){var t=d(this),e=t.text().trim(),i=t.closest("li").hasClass("disabled")?"page":"page bg-400 border-dark-subtle";t.parent().append(`<button class="${i}" type="button">${e}</button>`),t.remove()}),t.find("li.disabled").each(function(){d(this).children(".page").addClass("disabled")})}function c(t){return d("#"+t._options.domId).find("[data-table]")}function u(t){return d("#"+t._options.domId).find("[data-pagination-container]")}function p(t){clearTimeout(t._hideLoadingIndicatorTimeout),y(t).addClass("show").css("width","100%")}function f(t){const e=y(t);e.removeClass("show"),t._hideLoadingIndicatorTimeout=setTimeout(function(){e.css("width","0")},250)}function g(t,e){var i={instance:t,eventType:e},a=Array.from(arguments).slice(2);a.unshift(i),t.events.emit(e,...a)}function m(){var t=this._viewModel.pageNumber,e=this._viewModel.itemsPerPage,i=(t-1)*e,i=this._localItems.slice(i,i+e);this._setData({total:this._localItems.length,pagination:{pageNumber:t},items:i})}const _="table-active",b={loading:"loading",beforeDataSet:"beforeDataSet",afterDataSet:"afterDataSet",queryChanged:"queryChanged",selectedRowChanged:"selectedRowChanged",loadComplete:"loadComplete"},w={domId:"",url:"",urlParams:function(){return{}},columns:[],isSelectable:!1,itemsPerPage:15,localItems:null},v={id:"",columnName:"",field:"",fieldType:"",hasSort:!0,hasFilter:!0,placeholder:null},y=function(t){return d("#"+t._options.domId).find("[data-loading-backdrop]")};function t(t){const a=this;if(this.events=new i.default,!t.columns.length)throw new Error("at least one column must be specified");this._loadingData=!1,this._options=d.extend(!0,{},w,t),this._columns=[],this._columnFilters=[],this._sort=null,this._filter=null,this._lastParamsJsonStringified=null,this._localItems=t.localItems,this._hasLocalItems=this._localItems instanceof Array,this._hasLocalItems&&(this._loadData=m),this._hideLoadingIndicatorTimeout,this._viewModel={items:h.observableArray([]),total:0,itemsPerPage:this._options.itemsPerPage,pageNumber:1,hasFilters:h.observable(!1)};var e=c(this),e=(this._tableHtml=e[0].outerHTML,this.setColumns(t.columns),this.events.on(b.queryChanged,function(){a._onQueryChanged()}),this.events.on(b.afterDataSet,function(t){var e,i,a=d("#"+t.instance._options.domId).find("[data-update-container]"),o=(a.removeAttr("data-has-sort").removeAttr("data-has-filter"),t.instance.getQuery()),o=(o.sort&&a.attr("data-has-sort",!0),o.filter.getCriteria());o.length&&a.attr("data-has-filter",!0),o=t.instance,a=o.getContainer().find("[data-count-items-placeholder]"),i=o._viewModel.total,e=n(i).format("0,0"),o=`Page ${o._viewModel.pageNumber} from ${e} `+(1===i?"item":"items"),a.html(o),e=t.instance,i=e.getContainer().find("[data-query-placeholder]"),e=s.searchTableQueryText(e),i.html(e)}),this.events.on(b.loading,function(t){p(t.instance)}),this.events.on(b.afterDataSet,function(t){f(t.instance)}),this.events.once(b.afterDataSet,function(t){d("#"+t.instance._options.domId).attr("data-table-data-loaded",!0)}),this.getContainer());this._options.isSelectable&&e.on("click","tbody > tr",function(t){t.preventDefault(),t.stopPropagation();t=d(this).attr("data-row-id");a.selectRowById(t)}),e.on("click","[data-clear-filters-button]",function(t){t.preventDefault();t=new r;a.applyFilter(t)}),e.on("click","[data-reload-button]",function(t){t.preventDefault();const e=this;let i=o.Button.getOrCreateInstance(e);i.toggleDisabled(!0),a.events.once(b.afterDataSet,function(){(i=o.Button.getOrCreateInstance(e)).toggleDisabled(!1)}),a.reload()}),p(this)}return t.prototype._loadData=function(t){const e=this;var i,a,o,n;!0===this._loadingData?console.info("table data is already loading"):(a={},(i=this)._sort&&(a.sort={field:i._sort.field,direction:i._sort.direction}),o=i._filter||new r,a.criteria=o.getCriteria(),a.pagination={itemsPerPage:i._viewModel.itemsPerPage,pageNumber:i._viewModel.pageNumber,countTotal:!0},n=i._options.urlParams(),i=JSON.stringify({data:n,sort:i._sort?i._sort.toJSON():null,filter:o.toJSON(),pagination:a.pagination}),n.query=a,o={jsonStringified:i,data:n},t||this._lastParamsJsonStringified!==o.jsonStringified?(this._lastParamsJsonStringified=o.jsonStringified,this._loadingData=!0,g(this,b.loading),d.post(this._options.url,o.data).done(t=>{e._setData(t)}).fail(function(t){s.showXhrErrorToast(t,!1),e._loadingData=!1,f(e)}).always(function(t){g(e,b.loadComplete)})):console.info("the current table records have already been loaded with the same query."))},t.prototype._setData=function(t){g(this,b.beforeDataSet),this._viewModel.total=t.total,this._viewModel.currentPage=t.pagination.pageNumber,this._viewModel.items(t.items),this._createPagination(),this._loadingData=!1,g(this,b.afterDataSet)},t.prototype._createPagination=function(){const i=this,a=u(this);a.pagination({items:this._viewModel.total,itemsOnPage:this._viewModel.itemsPerPage,currentPage:this._viewModel.pageNumber,ellipsePageSet:!1,cssStyle:"",listStyle:"pagination mb-0",onPageClick:function(t,e){e.preventDefault(),l(a),i._viewModel.pageNumber=t,i._loadData()}}),a.children("ul").addClass("mb-0"),l(a)},t.prototype._onQueryChanged=function(){const t=this;clearTimeout(this._queryChangedTimeout),this._queryChangedTimeout=setTimeout(function(){t._loadData()},25)},t.prototype.getTable=function(){return c(this)},t.prototype.getContainer=function(){return d("#"+this._options.domId)},t.prototype.addColumnFilter=function(t){const e=d.extend(!0,{},v,t);t=this._columns.find(t=>t.id===e.id);if(!t)throw new Error(`table does not have a column with id '${e.id}'`);var i=c(this).find("th").eq(t.thIndex);i.length?(i=new a({$th:i,columnName:e.columnName,field:e.field,fieldType:e.fieldType,hasSort:e.hasSort,hasFilter:e.hasFilter,placeholder:e.placeholder,searchTableInstance:this}),this._columnFilters.push(i)):console.warn(`table does not contain <th data-id='${t.id}' />`)},t.prototype.setColumns=function(i){let t=c(this);h.disposeKoViewModel(this._viewModel,t,!1),t.after(this._tableHtml),t.remove();var e,a,o,n,s=(t=c(this)).find("thead").children("tr"),r=t.find("tbody").children("tr");for(let t=0,e=i.length;t<e;t++){var l=i[t];s.append(l.th),r.append(l.td)}this._columns=i.map((t,e)=>({thIndex:e,id:t.id})),e=this,e=c(e),a=e.children("thead").find("th").length,(n=[]).push("<div>"),n.push("<div data-bind='if: hasFilters()'>No items matching the current criteria were found</div>"),n.push("<div data-bind='if: !hasFilters()'>No items were found</div>"),n.push("</div>"),(o=[]).push("<tfoot data-bind='if: items().length === 0'><tr>"),o.push(`<td colspan='${a}'>`+n.join("")+"</td>"),o.push("</tr></tfoot>"),a=d(o.join("")),e.append(a),h.applyBindings(this._viewModel,t[0]),n=this,y(n)[0].addEventListener("transitionend",function(t){t=d(t.target);t.hasClass("show")||t.css("width","0")})},t.prototype.applySort=function(t){if(t instanceof e==!1)throw new Error("sort must be instanceof SortOperator",t);this._sort=e.clone(t),g(this,b.queryChanged)},t.prototype.applyFilter=function(t){if(t instanceof r==!1)throw new Error("sort must be instanceof FilterConstructor",t);this._viewModel.pageNumber=1,this._filter=r.clone(t),this._viewModel.hasFilters(0<t.getCriteria().length),g(this,b.queryChanged)},t.prototype.getQuery=function(){return{sort:null===this._sort?null:e.clone(this._sort),filter:r.clone(this._filter||new r)}},t.prototype.reload=function(){let e=this.getTable(),i=e.children("tbody").children("tr").eq(0);if(i.length&&i.attr("data-row-id")){const a=i.attr("data-row-id");this.events.once(b.afterDataSet,function(t){e=t.instance.getTable(),(i=e.children("tbody").children(`tr[data-row-id='${a}']`)).length&&i.prev("tr").length&&i.addClass("border-top-2").css("border-top-color","var(--falcon-primary-border-subtle)")})}this._loadData(!0)},t.prototype.getData=function(){return this._viewModel.items()},t.prototype.selectRowById=function(t){var e,i;t&&((i=(e=this.getTable()).children("tbody").children(`tr[data-row-id='${t}']`)).length?(e.children("tbody").children("tr").removeClass(_),i.addClass(_),g(this,b.selectedRowChanged)):console.warn(`Row with [data-row-id] ${t} was not found`))},t.prototype.selectRowByIndex=function(t){var e=this.getTable(),i=e.children("tbody").children("tr").eq(t);i.length?(e.children("tbody").children("tr").removeClass(_),i.addClass(_),g(this,b.selectedRowChanged)):console.warn(`Row with index ${t} was not found`)},t.prototype.getSelectedRow=function(){var t=this.getTable().children("tbody").children("tr."+_);return t.length?{$row:t,data:h.dataFor(t[0])}:null},t.prototype.destroy=function(){for(let t=0,e=this._columnFilters.length;t<e;t++)this._columnFilters[t].destroy();this._columnFilters.length=0;var t=c(this);h.disposeKoViewModel(this._viewModel,t,!0),this.events.destroy(),u(this).pagination("destroy")},t.EVENT_TYPES=b,t});